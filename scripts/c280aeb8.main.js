$(function(){function a(){console.log("init."),FB.getLoginStatus(function(a){console.log(a),"connected"===a.status?(console.log("Logged in."),FB.api("/me",function(a){document.getElementById("status").innerHTML="歡迎登入："+a.name+"!"})):(console.log("login."),FB.login())})}function b(a){var b="<p>Time:"+moment().format("YYYY/MM/DD, HH:mm:ss")+"</p><p>"+a+"</p>";$("#messages").prepend(b)}function c(a,b,c,d){var e=g.format("%s/feed",a);FB.api(e,{limit:10},function(a){var e=a.data,f=[];for(var g in e){var h=e[g];h&&h.message&&h.message.indexOf(b)>=0&&f.push(h)}f.length>0?c(f):d()})}function d(a,b,c,d){var e=g.format("%s/comments",a);FB.api(e,"post",{message:b},function(a){a.id?c&&c(a):d&&d(a)})}var e,f={},g={format:function(){for(var a=arguments[0],b=1;b<arguments.length;b++)a=a.replace("%s",arguments[b]);return a}};window.fbAsyncInit=function(){FB.init({appId:"119272321550408",xfbml:!0,version:"v2.3"}),a()},function(a,b,c){var d,e=a.getElementsByTagName(b)[0];a.getElementById(c)||(d=a.createElement(b),d.id=c,d.src="//connect.facebook.net/en_US/sdk.js",e.parentNode.insertBefore(d,e))}(document,"script","facebook-jssdk");var h=function(a,e,h){var i=this;this.interval=null,this.search_pattern=e,this.apply_message=h,this.fn=function(){b("搜尋報名留言處..."),c(a,i.search_pattern,function(a){$.each(a,function(a,c){var e=c.id.split("_")[1];if(!f[e]){f[e]=!0;var h=g.format("搜尋到報名留言處, 留言內容=%s,comment_id(%s)!",c.message,e);b(h),d(e,i.apply_message,function(a){b(g.format("FB報名成功 result=%s",JSON.stringify(a)))},function(a){f[e]=!1,b(g.format("FB報名失敗 result=%s",JSON.stringify(a)))})}})},function(){b("找不到留言處..繼續搜尋")})},this.start=function(){this.end(),this.interval=setInterval(this.fn,500)},this.end=function(){this.interval&&(clearInterval(this.interval),this.interval=null)}},i=function(a,c){FB.api("/search?q="+encodeURIComponent(a)+"&type=event",function(d){if(d.data)if(d.data instanceof Array){var e=d.data;if(e.length<=0)b(g.format("找不到有關鍵字：%s 的活動.",a));else if(1==e.length){var f=e[0].id,h="找到活動，名稱："+e[0].name;b(h),c&&c({id:f,name:e[0].name})}else{for(var i=[],j=0;j<e.length;j++)i.push(e[j].name);b("找到超過1個活動，不做自動報名，關鍵字:"+a+", Events:"+i.join("<br/>"))}}else console.log(d);else b("搜尋活動出現錯誤，原因:"+d.error.message)})};$("#find_event").click(function(){var a=$("#search_text").val();a.length>0?i(a,function(a){$("#step1").hide(),$("#step1-info h3").text("活動名稱：【"+a.name+"】").parent().show(),$("#step2").show(),$("#event_id").val(a.id)}):alert("請輸入字活動關鍵字.")}),$("#start_apply").click(function(){e&&e.end();var a=$("#search_pattern").val(),b=$("#apply_message").val(),c=$("#event_id").val();return 0==a.length||b.lengh?void alert("欄位輸入不完整!"):(e=new h(c,a,b),e.start(),$("#start_apply").hide(),void $("#stop_apply").show())}),$("#stop_apply").click(function(){e&&e.end(),$("#start_apply").show(),$("#stop_apply").hide(),b("報名動作結束.")})});