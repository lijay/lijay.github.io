$(function(){function a(){console.log("init."),FB.getLoginStatus(function(a){console.log(a),"connected"===a.status?(console.log("Logged in."),FB.api("/me",function(a){document.getElementById("status").innerHTML="歡迎登入："+a.name+"!"})):(console.log("login."),FB.login())})}function b(a){g&&g.end();var b=$("#search_pattern").val(),c=$("#apply_message").val(),d=$("#event_id").val();return 0==b.length||c.lengh?void alert("欄位輸入不完整!"):(g=new k(d,b,c,a),g.start(),$("#start_apply").hide(),$("#start_simulate").hide(),void $("#stop_apply").show())}function c(a){var b="<p>Time:"+moment().format("YYYY/MM/DD, HH:mm:ss")+"</p><p>"+a+"</p>";$("#messages").prepend(b)}function d(a){var b="<li>"+moment().format("YYYY/MM/DD, HH:mm:ss")+" "+a+"</li>";$("#posted_logs").prepend(b)}function e(a,b,c,d){var e=j.format("%s/feed",a);FB.api(e,{limit:10},function(a){var e=a.data,f=[];for(var g in e){var h=e[g];h&&h.message&&h.message.indexOf(b)>=0&&f.push(h)}f.length>0?c(f):d()})}function f(a,b,c,d){var e=j.format("%s/comments",a);FB.api(e,"post",{message:b},function(a){a.id?c&&c(a):d&&d(a)})}var g,h={},i={},j={format:function(){for(var a=arguments[0],b=1;b<arguments.length;b++)a=a.replace("%s",arguments[b]);return a}};window.fbAsyncInit=function(){FB.init({appId:"119272321550408",xfbml:!0,version:"v2.3"}),a()},function(a,b,c){var d,e=a.getElementsByTagName(b)[0];a.getElementById(c)||(d=a.createElement(b),d.id=c,d.src="//connect.facebook.net/en_US/sdk.js",e.parentNode.insertBefore(d,e))}(document,"script","facebook-jssdk");var k=function(a,b,g,k){var l=this;this.interval=null,this.simulate=k,this.search_pattern=b,this.apply_message=g,this.fn=function(){c("搜尋報名留言處..."),e(a,l.search_pattern,function(a){$.each(a,function(a,b){var e=b.id.split("_")[1];if(l.simulate)i[e]||(i[e]=!0,d(j.format("[模擬]已搜尋到報名留言: message=%s",b.message)));else if(!h[e]){h[e]=!0;var g=j.format("搜尋到報名留言處, 留言內容=%s,comment_id(%s)!",b.message,e);c(g),f(e,l.apply_message,function(a){c(j.format("FB報名成功 result=%s",JSON.stringify(a))),d(j.format("已留言: (%s) message=%s",a.id,b.message))},function(a){h[e]=!1,c(j.format("FB報名失敗 result=%s",JSON.stringify(a)))})}})},function(){c("找不到留言處..繼續搜尋")})},this.start=function(){this.end(),this.interval=setInterval(this.fn,500)},this.end=function(){this.interval&&(clearInterval(this.interval),this.interval=null)}},l=function(a,b){FB.api("/search?q="+encodeURIComponent(a)+"&type=event",function(d){if(d.data)if(d.data instanceof Array){var e=d.data;if(e.length<=0)c(j.format("找不到有關鍵字：%s 的活動.",a));else if(1==e.length){var f=e[0].id,g="找到活動，名稱："+e[0].name;c(g),b&&b({id:f,name:e[0].name})}else{for(var h=[],i=0;i<e.length;i++)h.push(e[i].name);c("找到超過1個活動，不做自動報名，關鍵字:"+a+", Events:"+h.join("<br/>"))}}else console.log(d);else c("搜尋活動出現錯誤，原因:"+d.error.message)})};$("#find_event").click(function(){var a=$("#search_text").val();a.length>0?l(a,function(a){$("#step1").hide(),$("#step1-info h3").text("活動名稱：【"+a.name+"】").parent().show(),$("#step2").show(),$("#event_id").val(a.id)}):alert("請輸入字活動關鍵字.")}),$("#start_simulate").click(function(){b(!0)}),$("#start_apply").click(function(){b(!1)}),$("#stop_apply").click(function(){g&&g.end(),$("#start_apply").show(),$("#start_simulate").show(),$("#stop_apply").hide(),c("報名動作結束.")})});